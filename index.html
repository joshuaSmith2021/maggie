<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8">
    <title>Maggie</title>
    <base href="https://chessboardjs.com/"/>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
    <div class="row">
        <div class="col-md-3">
            <div id="myBoard" style="height:400px"></div>
        </div>
        <div class="col-md-3">
            <p id="moves">Starting Position</p>
            <a href="#" data-toggle="tooltip" data-placement="bottom" title="d4, e4" id="moveTooltip">Possible Moves</a>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" value="" id="forceOpenings">

                <label for="forceOpenings" class="form-check-label">
                    Force Openings
                </label>
            </div>

            <div class="btn">
                <i class="material-icons" onclick="takeback()">chevron_left</i>
            </div>
        </div>
    </div>
    <script>
// --- Begin Example JS --------------------------------------------------------
// NOTE: this example uses the chess.js library:
// https://github.com/jhlywa/chess.js

var board = null
var game = new Chess()
var whiteSquareGrey = '#a9a9a9'
var blackSquareGrey = '#696969'

const openings = ["1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 a6 6. Be3 e5 7. Nb3 Be6 8. f3 Be7 9. Qd2 O-O 10. O-O-O Nbd7 11. g4 b5 12. g5 b4 13. Ne2 Ne8 14. f4 a5", "1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 a6 6. Be3 e5 7. Nb3 Be6 8. f3 Nbd7 9. g4 Nb6 10. g5 Nh5 11. Qd2 Be7 12. O-O-O O-O 13. Rg1 Rc8 14. Kb1 g6", "1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 a6 6. Be3 e5 7. Nb3 Be6 8. f3 Be7 9. Qd2 O-O 10. O-O-O Qc7 11. g4 Rc8 12. g5 Nh5 13. Kb1 Nd7 14. Qf2 b5", "1. e4 c5 2. Nf3 d6 3. d4 cxd4 4. Nxd4 Nf6 5. Nc3 a6 6. Be3 e5 7. Nb3 Be6 8. f3 Be7 9. Qd2 O-O 10. O-O-O b5 11. Nd5 Bxd5 12. exd5 Qc7 13. g4 Rc8 14. Kb1 b4"]

var possibleLines = openings

function takeback() { game.undo(); board.position(game.fen()); updatePgn(); }

$('#logLines').click(function() {
    console.log(possibleLines)
})

function updateLines() {
    let string = listToPgn(game.history())
    let newLines = []
    for (let i = 0; i < possibleLines.length; i++) {
        let currentLine = possibleLines[i]
        if (currentLine.indexOf(string) !== -1) {
            newLines.push(currentLine)
        }
    }

    possibleLines = newLines
}

function pgnToList(pgn) {
    let groups = pgn.split(' ')
    return groups.filter(group => group.charAt(group.length - 1) !== '.')
}

function listToPgn(list) {
    let result = []
    for (let i = 0; i < list.length; i++) {
        if (i % 2 === 0) result.push(`${i / 2 + 1}.`)
        result.push(list[i])
    }
    return result.join(' ')
}

function getCorrectMoves() {
    let string = listToPgn(game.history())
    let moves = []

    for (let i = 0; i < possibleLines.length; i++) {
        let current = possibleLines[i];
        let nextMove = current.replace(string, '').split(' ').filter(x => x.charAt(x.length - 1) !== '.' && x !== '')[0]
        if (moves.indexOf(nextMove) === -1) moves.push(nextMove)
    }

    return moves;
}

function updatePgn() {
    $('#moves').text(listToPgn(game.history()))

    let moveList = getCorrectMoves().join(', ')
    if (moveList === '') {
        moveList = 'No moves in database'
    }

    $('#moveTooltip').attr('data-original-title', moveList)
}

function correctMove(move) {
    let correctMoves = getCorrectMoves();
    let attemptedMove = move.san;

    return correctMoves.indexOf(attemptedMove) !== -1;
}

function removeGreySquares () {
    $('#myBoard .square-55d63').css('background', '')
}

function greySquare (square) {
    var $square = $('#myBoard .square-' + square)

    var background = whiteSquareGrey
    if ($square.hasClass('black-3c85d')) {
        background = blackSquareGrey
    }

    $square.css('background', background)
}

function onDragStart (source, piece) {
    // do not pick up pieces if the game is over
    if (game.game_over()) return false

    // or if it's not that side's turn
    if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
        return false
    }
}

function onDrop (source, target) {
    removeGreySquares()

    let correctMoves = getCorrectMoves();

    // see if the move is legal
    var move = game.move({
        from: source,
        to: target,
        promotion: 'q' // NOTE: always promote to a queen for example simplicity
    })

    // illegal move
    if (move === null) return 'snapback'

    // see if the move is in a line
    if (
        correctMoves.indexOf(move.san) === -1 &&
        !correctMoves.length === 0 &&
        $('#forceOpenings').is(':checked')
    ) {
        takeback()
        return 'snapback'
    }

    updatePgn()
}

function onMouseoverSquare (square, piece) {
    // get list of possible moves for this square
    var moves = game.moves({
        square: square,
        verbose: true
    })

    // exit if there are no moves available for this square
    if (moves.length === 0) return

    // highlight the square they moused over
    greySquare(square)

    // highlight the possible squares for this piece
    for (var i = 0; i < moves.length; i++) {
        greySquare(moves[i].to)
    }
}

function onMouseoutSquare (square, piece) {
    removeGreySquares()
}

function onSnapEnd () {
    board.position(game.fen())
    updateLines()
}

var config = {
    draggable: true,
    position: 'start',
    onDragStart: onDragStart,
    onDrop: onDrop,
    onMouseoutSquare: onMouseoutSquare,
    onMouseoverSquare: onMouseoverSquare,
    onSnapEnd: onSnapEnd
}

board = Chessboard('myBoard', config)

$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip()

    let moveList = getCorrectMoves().join(', ')
    $('#moveTooltip').attr('data-original-title', moveList)
    $('#moveTooltip').attr('data-original-title', moveList)
})
    </script>
</body>
</html>
